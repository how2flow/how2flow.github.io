---
permalink: /posts/ebb42/
title: "[klipper] ebb42 캔 버스 보드 펌웨어 업데이트"
categories:
  - 3d-printer
tags:
  - can
  - firmware
  - klipper
toc: true
---

## intro
회사 고객 중에서 can 통신 관련해서 이슈가 들어왔습니다.<br>
[forum](https://forum.odroid.com/viewtopic.php?p=369575#p369575)<br><br>

내용은 EBB42(3D 프린터 부품) 보드를 ODROID-M1과 함께 사용하는 내용이었습니다.<br>

<p align="center">
  <img src="/documents/images/odroid/odroid-m1.jpg" alt="ODROID-M1" width="320" height="240">
  <img src="/assets/images/posts/ebb42.jpg" alt="ebb42" width="320" height="240"><br>
  <span style="{{ site.img }}">ODROID-M1과 EBB 42 보드</span>
</p>
<br>

EBB보드는 CAN버스에 물릴 수 있고, odroid-m1은 native can이 지원되기 때문입니다.<br>
정리가 좀 필요해서 기록용으로 올립니다.<br>

## 준비물

```
- ODROID-M1 x1
- EBB42 CAN V1.0 x1
- SN65HVD230 x1
```

## EBB42 보드 (CAN V1.0)

<p align="center">
  <img src="/assets/images/posts/ebb42.jpg" alt="ebb42" width="640" height="480"><br>
  <span style="{{ site.img }}">EBB 42 보드</span>
</p>

EBB 보드입니다.<br>
구매는 [여기](https://aliexpress.com/item/1005004243206192.html)서 가능하고 공식 [레포지토리](https://github.com/bigtreetech/EBB)를 확인할 수 있습니다.<br>
펌웨어는 업로드 날짜(2023-05-10)기준으로 [Klipper](https://www.klipper3d.org/)만 지원합니다.<br>

그래서 이번 주제인 펌웨어 업데이트는 klipper 펌웨어 업데이트 입니다.<br>
제가 가지고 있는 모델은 EBB보드 중에서 **EBB42 CAN V1.0** 입니다.<br>
버전에 따라서 펌웨어 설정과 업데이트 방법이 다릅니다.<br>
[공식 문서](https://github.com/bigtreetech/EBB/blob/master/README.md) 확인하세요.<br>

### Klipper 펌웨어 업데이트

펌웨어 업데이트는 캔 버스를 통해서 업데이트 합니다.<br>
[메뉴얼 1](https://github.com/bigtreetech/EBB#build-firmware-image), [메뉴얼 2](https://www.klipper3d.org/Bootloaders.html#stm32f103stm32f0x2-with-canboot-bootloader) 참고하였습니다.<br>

#### klipper 다운로드 및 빌드

github 소스를 다운받습니다.
```
$ git clone https://github.com/Klipper3d/klipper
```

klipper 소스 빌드 합니다.
```
$ cd klipper
$ make menuconfig
```
```
[*] Enable extra low-level configuration options
    Micro-controller Architecture (STMcroelectronics STM32)
    Processor model (STM32F072)
    Bootloader offset (No bootloader)
    Clock Reference (8 MHz crystal)
    Communication interface (CAN bus (on PA8/PA9))
()  GPIO pins to set at micro-controller startup
```

<span style="{{ site.code }}">q</span>를 누르고 <span style="{{ site.code }}">Y</span>로 저장 하고 빠져나옵니다.
```
$ make
```
<span style="{{ site.code }}">out/klipper.bin</span>이 생성된 것을 확인할 수 있습니다.<br>

#### Canboot 다운로드 및 빌드

CAN을 통한 klipper 펌웨어 업데이트를 위해 설치가 필요합니다.<br>
```
$ cd
$ git clone https://github.com/Arksine/CanBoot
$ cd CanBoot
$ make menuconfig
```
```
    Micro-controller Architecture (STMcroelectronics STM32)
    Processor model (STM32F072)
    Build CanBoot deployment application (Do not build)
    Clock Reference (8 MHz crystal)
    Communication interface (CAN bus (on PA8/PA9))
    Application start offset (8KiB offset)
(250000) CAN bus speed
()  GPIO pins to set on bootloader entry
[*] Support bootloader entry on rapid dobule click of reset button
[ ] Enable bootloader entry on button (or gpio) state
[ ] Enable Status LED
```

<span style="{{ site.code }}">q</span>를 누르고 <span style="{{ site.code }}">Y</span>로 저장 하고 빠져나옵니다.

CanBoot 빌드
```
$ make clean
$ make
```

#### 설치

M1에서 CAN버스를 구성해야합니다.<br>
[Wiki](https://wiki.odroid.com/odroid-m1/application_note/gpio/can-bus_rk)를 참고합니다.<br>
```
$ sudo ifconfig can0 down
$ sudo ip link set can0 type can bitrate 250000
$ sudo ifconfig can0 up
```

EBB보드와 M1을 USB로 연결합니다.<br>
연결할 때 USB는 3.0포트로 연결합니다.
```
$ lsusb
Bus 001 Device 004: ID 0483:df11 STMicroelectronics STM Device in DFU Mode
```

canboot를 EBB보드에 설치합니다.
```
$ sudo dfu-util -a 0 -D ~/CanBoot/out/canboot.bin --dfuse-address 0x08000000:force:mass-erase:leave -d 0483:df11
```

보드와 CANbus를 연결하고 장치의 uuid를 확인합니다.
```
$ python3 ~/klipper/lib/canboot/flash_can.py -q
```

flash
```
$ python3 ~/klipper/lib/canboot/flash_can.py i can0 -f ~/klipper/out/klipper.bin -u "your_EBB_uuid"
```

펌웨어 업데이트 결과를 확인할 수 있습니다.<br>

<p align="center">
  <img src="/assets/images/posts/flash_can.png" alt="flash_can" width="640" height="480"><br>
  <span style="{{ site.img }}">펌웨어 업데이트 로그</span>
</p>
<br>

<p align="center">
  <img src="/assets/images/posts/can_status.png" alt="can_status" width="640" height="480"><br>
  <span style="{{ site.img }}">펌웨어 업데이트 후 CAN버스</span>
</p>
<br>

3d프린터에 연결해서 동작 확인이랑 디버깅 정도 할 것 같습니다.<br>
